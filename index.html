<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lookup Player Name by PlayFabId</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <!-- ฟอนต์ไทย (ทางเลือก) -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet" />
  <style> body{ font-family:'Sarabun',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial; } </style>
  <!-- PlayFab Client SDK -->
  <script src="https://download.playfab.com/PlayFabClientApi.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-md rounded-xl shadow-lg p-6">
    <h1 class="text-2xl font-semibold text-center text-gray-800 mb-1">ค้นหาชื่อผู้เล่นด้วย PlayFabId</h1>
    <p class="text-center text-gray-500 mb-6">กรอก <b>Title Player Account ID</b> (PlayFabId)</p>

    <div id="alertBox" class="hidden mb-4 rounded-md border border-red-200 bg-red-50 text-red-700 px-3 py-2 text-sm"></div>
    <div id="infoBox"  class="hidden mb-4 rounded-md border border-blue-200 bg-blue-50 text-blue-700 px-3 py-2 text-sm"></div>

    <label class="block text-sm font-medium text-gray-700 mb-1" for="titleId">Title ID</label>
    <input id="titleId" type="text" class="mb-4 w-full rounded-lg border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-blue-200"
           placeholder="YOUR_PLAYFAB_TITLE_ID" />

    <label class="block text-sm font-medium text-gray-700 mb-1" for="playFabId">Title Player Account ID (PlayFabId)</label>
    <input id="playFabId" type="text" class="mb-4 w-full rounded-lg border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-blue-200"
           placeholder="เช่น 2CD9EC55674481C3" />

    <button id="lookupBtn"
      class="w-full rounded-lg bg-blue-600 text-white py-2.5 font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-60">
      ค้นหาชื่อผู้เล่น
    </button>

    <div class="mt-6 border-t pt-4">
      <p class="text-gray-700">ผลลัพธ์:</p>
      <div id="result" class="mt-2 text-lg font-semibold text-gray-900">—</div>
    </div>
  </div>

  <script>
    function $(id){ return document.getElementById(id); }
    function showError(msg){ const b=$('alertBox'); b.textContent=msg; b.classList.remove('hidden'); }
    function hideError(){ $('alertBox').classList.add('hidden'); }
    function info(msg){ const b=$('infoBox'); b.textContent=msg; b.classList.remove('hidden'); }
    function hideInfo(){ $('infoBox').classList.add('hidden'); }
    function setBusy(b){ const btn=$('lookupBtn'); btn.disabled=!!b; btn.textContent=b?'กำลังค้นหา...':'ค้นหาชื่อผู้เล่น'; }

    let sessionReady = false;

    async function ensureTempLogin(titleId){
      return new Promise(resolve=>{
        if (sessionReady) return resolve(true);
        if (!titleId) return resolve(false);

        if (typeof PlayFabClientSDK === 'undefined') {
          showError('โหลด PlayFab SDK ไม่สำเร็จ'); return resolve(false);
        }
        PlayFab.settings.titleId = titleId;

        const customId = 'web-lookup-' + Math.random().toString(36).slice(2);
        PlayFabClientSDK.LoginWithCustomID({
          TitleId: titleId,
          CustomId: customId,
          CreateAccount: true
        }, function(ok, err){
          if (!ok) {
            showError('Login ชั่วคราวไม่สำเร็จ: ' + ((err && err.errorMessage) || ''));
            return resolve(false);
          }
          sessionReady = true;
          resolve(true);
        });
      });
    }

    function getNiceNameFromAccountInfo(accInfo){
      // รองรับโครงสร้างทั้งแบบ data.AccountInfo และ AccountInfo
      const a = accInfo?.data?.AccountInfo || accInfo?.AccountInfo || null;
      if (!a) return null;
      const dn = a?.TitleInfo?.DisplayName;
      if (dn) return dn;
      return a?.Username || null;
    }

    function lookupNameByPlayFabId(playFabId){
      return new Promise(resolve=>{
        PlayFabClientSDK.GetAccountInfo({ PlayFabId: playFabId }, function(ok, err){
          if (!ok) {
            return resolve({ ok:false, error: (err && err.errorMessage) || 'GetAccountInfo failed' });
          }
          const name = getNiceNameFromAccountInfo(ok);
          resolve({ ok:true, name });
        });
      });
    }

    $('lookupBtn').addEventListener('click', async ()=>{
      hideError(); hideInfo(); $('result').textContent = '—';

      const titleId = $('titleId').value.trim();
      const playFabId = $('playFabId').value.trim();

      if (!titleId || titleId === 'YOUR_PLAYFAB_TITLE_ID') return showError('กรุณากรอก Title ID ให้ถูกต้อง');
      if (!playFabId) return showError('กรุณากรอก PlayFabId');

      setBusy(true);
      const okLogin = await ensureTempLogin(titleId);
      if (!okLogin) { setBusy(false); return; }

      const res = await lookupNameByPlayFabId(playFabId);
      setBusy(false);

      if (!res.ok) {
        // ข้อผิดพลาดพบบ่อย:
        // - "User not found" → PlayFabId ไม่อยู่ใน Title นี้
        // - "NotAuthenticated" → ยังไม่ได้ login ด้วย TitleId เดียวกัน
        showError(res.error || 'ค้นหาไม่สำเร็จ');
        return;
      }

      if (!res.name) {
        info('พบผู้เล่น แต่ยังไม่มี DisplayName/Username ที่ตั้งไว้');
        $('result').textContent = '(ไม่มีชื่อที่ตั้งไว้)';
        return;
      }

      $('result').textContent = res.name;
    });

    // เติม TitleId อัตโนมัติเพื่อกันพิมพ์ตกหล่น (ลบได้ถ้าไม่ต้องการ)
    $('titleId').placeholder = 'YOUR_PLAYFAB_TITLE_ID';
  </script>
</body>
</html>
