<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Player Profile & Clan Lookup</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet" />
  <style>body{ font-family:'Sarabun',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial; }</style>
  <script src="https://download.playfab.com/PlayFabClientApi.js"></script>
</head>
<body class="bg-zinc-900 min-h-screen flex items-center justify-center p-4 text-zinc-100">
  <div class="bg-zinc-800 w-full max-w-xl rounded-2xl shadow-xl p-6">
    <div class="flex items-center gap-3 mb-5">
      <div class="w-1.5 h-8 rounded bg-indigo-400"></div>
      <h1 class="text-2xl font-semibold">Player Profile</h1>
      <span class="ml-auto text-sm opacity-75">Title: <b>2F5F0</b></span>
    </div>

    <div id="alert" class="hidden mb-4 rounded-md border border-red-400/30 bg-red-900/40 text-red-200 px-3 py-2 text-sm"></div>

    <label for="pfid" class="block text-sm mb-1 opacity-80">Title Player Account ID (PlayFabId)</label>
    <input id="pfid" type="text" class="mb-4 w-full rounded-lg bg-zinc-900 border-zinc-700 px-3 py-2 focus:border-indigo-400 focus:ring-indigo-300"
           placeholder="เช่น 260EF77E1F3AB550" />

    <button id="lookup" class="w-full rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white py-2.5 font-medium">ค้นหา</button>

    <div id="card" class="hidden mt-6 rounded-xl bg-zinc-900/60 border border-zinc-700 p-5">
      <div>
        <div id="displayName" class="text-xl font-bold">—</div>
        <div id="username" class="text-sm opacity-70">—</div>
      </div>

      <div class="grid grid-cols-2 gap-4 mt-5 text-sm">
        <div><div class="opacity-60">Player ID</div><div id="playFabId" class="font-medium break-all">—</div></div>
        <div><div class="opacity-60">Created</div><div id="created" class="font-medium">—</div></div>
        <div class="col-span-2">
          <div class="opacity-60">Clan</div>
          <div id="clan" class="font-medium">—</div>
        </div>
      </div>

      <div id="stamp" class="mt-4 text-xs opacity-60">—</div>
    </div>
  </div>

  <script>
    const TITLE_ID = "F7659";
    const CLOUDSCRIPT_FUNC = "GetClanByPlayFabId";

    const $ = id => document.getElementById(id);
    const showErr = m => { const a=$('alert'); a.textContent=m; a.classList.remove('hidden'); };
    const clearErr = () => $('alert').classList.add('hidden');
    const fmt = dt => { if(!dt) return '—'; const d=new Date(dt); return isNaN(d) ? String(dt) : d.toLocaleString(); };

    let sessionReady = false;
    function ensureLogin() {
      return new Promise(res => {
        if (sessionReady) return res(true);
        PlayFab.settings.titleId = TITLE_ID;
        const cid = 'lookup-' + Math.random().toString(36).slice(2);
        PlayFabClientSDK.LoginWithCustomID({ TitleId: TITLE_ID, CustomId: cid, CreateAccount: true }, (ok, e) => {
          if (!ok) { showErr('Login ล้มเหลว: ' + (e?.errorMessage || '')); return res(false); }
          sessionReady = true; res(true);
        });
      });
    }

    function getAccountInfo(playFabId){
      return new Promise(res=>{
        PlayFabClientSDK.GetAccountInfo({ PlayFabId: playFabId }, (ok, e)=>{
          if(!ok) return res({ ok:false, error: e?.errorMessage || 'GetAccountInfo failed' });
          const a = ok.data?.AccountInfo || ok.AccountInfo || {};
          res({ ok:true, info: {
            displayName: a?.TitleInfo?.DisplayName || null,
            username: a?.Username || null,
            created: a?.TitleInfo?.Created || null
          }});
        });
      });
    }

    function getClanViaCloudScript(playFabId){
      return new Promise(res=>{
        PlayFabClientSDK.ExecuteCloudScript({
          FunctionName: CLOUDSCRIPT_FUNC,
          FunctionParameter: { playFabId },
          GeneratePlayStreamEvent: false
        }, (ok, err) => {
          if (!ok) return res({ ok:false, error: err?.errorMessage || 'ExecuteCloudScript failed' });
          const r = ok.data?.FunctionResult;
          if (!r) return res({ ok:false, error: 'No FunctionResult' });
          res(r);
        });
      });
    }

    $('lookup').addEventListener('click', async ()=>{
      clearErr();
      const id = $('pfid').value.trim();
      if (!id) return showErr('กรุณากรอก PlayFabId');

      const okLogin = await ensureLogin();
      if (!okLogin) return;

      const acc = await getAccountInfo(id);
      if (!acc.ok) return showErr(acc.error || 'ค้นหาไม่สำเร็จ');

      const clan = await getClanViaCloudScript(id);

      $('card').classList.remove('hidden');
      $('playFabId').textContent = id;
      $('displayName').textContent = acc.info.displayName || '—';
      $('username').textContent = acc.info.username ? `@${acc.info.username}` : '—';
      $('created').textContent = fmt(acc.info.created);
      $('clan').textContent = (clan.ok && clan.clans?.length)
        ? clan.clans.map(c => `${c.name} (${c.id})`).join(', ')
        : '(ไม่อยู่แคลน หรือไม่พบข้อมูล)';
      $('stamp').textContent = `Player ID: ${id} | ${new Date().toLocaleString()}`;
    });
  </script>
</body>
</html>